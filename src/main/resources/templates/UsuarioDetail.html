<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
    <head>
        <title>Detalles Usuario</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!-- Bootstrap -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

        <!-- Icons -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

        <!-- SweetAlert -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <!--        <script src="https://code.jquery.com/jquery-3.7.1.js"></script>-->

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    </head>   
    <body class="container">

        <div class="container text-center rounded shadow-sm mt-4">
            <div class="row mb-3 align-items-start">

                <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom mb-4">
                    <div class="container-fluid">                      

                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                            <span class="navbar-toggler-icon"></span>
                        </button>

                        <div class="collapse navbar-collapse" id="navbarNav">
                            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                                <li class="nav-item" sec:authorize="hasRole('Admin')">
                                    <a class="nav-link text-dark" th:href="@{/usuario}"><i class="bi bi-house"></i> Inicio</a>
                                </li>
                                <li class="nav-item" sec:authorize="hasRole('Admin')">
                                    <a class="nav-link text-dark" th:href="@{/usuario/form}"><i class="bi bi-file-earmark-text"></i> Formulario</a>
                                </li>
                                <li class="nav-item" sec:authorize="hasRole('Admin')">
                                    <a class="nav-link text-dark" th:href="@{/usuario/CargaMasiva}"><i class="bi bi-file-earmark-arrow-up"></i> Carga Masiva</a>
                                </li>
                                <li class="nav-item" sec:authorize="hasRole('Admin')">
                                    <a class="nav-link text-dark" th:href="@{/usuario/detail/{IdUsuario} (IdUsuario = ${UsuarioL.IdUsuario})}"><i class="bi bi-vector-pen"></i> Mi perfil</a>
                                </li>
                            </ul>

                            <div class="d-flex align-items-center border-top pt-3 mt-2 pt-lg-0 mt-lg-0 border-lg-0 border-top-0">
                                <div class="d-flex align-items-center me-auto">
                                    <label class="me-2 mb-0 fw-bold" th:text="${UsuarioL.username}"></label>
                                    <div class="me-3">
                                        <img th:src="${UsuarioL.Imagen != null && UsuarioL.Imagen != 'null' ? 'data:image/*;base64,' + UsuarioL.Imagen : 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTNT31I-b-Jdf8bjPM-mm-V1qCpb-oudRLvtw&s'}"
                                             style="width: 35px; height: 35px; object-fit: cover; border-radius: 50%; border: 1px solid #ccc;"
                                             class="img-fluid" alt="Perfil">
                                    </div>
                                </div>

                                <form th:action="@{/logout}" method="post" class="m-0">
                                    <button class="btn btn-outline-danger btn-sm d-flex align-items-center" type="submit">
                                        <span class="d-lg-none me-2">Salir</span> <i class="bi bi-box-arrow-right"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </nav>

                <!-- INFORMACIÓN DEL USUARIO -->
                <div class="col">
                    <h3>Información Usuario</h3>

                    <div class="text-center mb-3">
                        <img th:src="${usuario.Imagen != null && usuario.Imagen != 'null' ? 'data:image/*;base64,' + usuario.Imagen : 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTNT31I-b-Jdf8bjPM-mm-V1qCpb-oudRLvtw&s'}"
                             style="width: 200px; height: 200px; object-fit: cover; border-radius: 50%; border: 2px solid #ddd;"
                             class="img-thumbnail">
                    </div>

                    <form th:action="@{/usuario/updateImagen}" method="post" enctype="multipart/form-data" id="formImagen">
                        <input type="hidden" name="idUsuario" th:value="${usuario.idUsuario}" />

                        <input th:disabled="${session.userEstatus == 0 || session.userEstatus == 2}" type="file" name="imagenFile" id="inputImagen" accept="image/*" style="display: none;" onchange="this.form.submit()" />

                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('inputImagen').click();">
                                <i class="bi bi-camera"></i> Cambiar Foto
                            </button>
                        </div>
                    </form>

                    <tr th:each="usuario : ${usuario}"></tr>

                    <div th:if="${Usuario != null}">
                        <p th:text="${Usuario.idUsuario}"></p>
                    </div>

                    <div class="row g-3">

                        <!-- NOMBRE Y APELLIDOS -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Nombre</label>
                            <input type="text" class="form-control" placeholder="Nombre"
                                   th:field="${usuario.Nombre}" onkeypress="SoloLetras(event, this)" readonly>
                            <span class="text-danger error-msg"></span>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Apellido Paterno</label>
                            <input type="text" class="form-control" placeholder="Apellido Paterno"
                                   th:field="${usuario.ApellidoPaterno}" onkeypress="SoloLetras(event, this)" readonly>
                            <span class="text-danger error-msg"></span>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Apellido Materno</label>
                            <input type="text" class="form-control" placeholder="Apellido Materno"
                                   th:field="${usuario.ApellidoMaterno}" onkeypress="SoloLetras(event, this)" readonly>
                            <span class="text-danger error-msg"></span>
                        </div>

                        <!-- USERNAME, Rol -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Username</label>
                            <input type="text" class="form-control" placeholder="username"
                                   th:field="${usuario.username}" onkeypress="username(event, this)" readonly>
                            <span class="text-danger error-msg"></span>
                        </div>

                        <!--                                                <div class="col-md-6 mb-3">
                                                                            <label class="form-label fw-bold">Password</label>
                                                                            <input type="password" class="form-control" placeholder="password"
                                                                                   th:field="${usuario.password}" oninput="password(event, this)">
                                                                            <span class="text-danger error-msg"></span>
                                                                        </div>-->

                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Rol</label>
                            <input type="text" class="form-control" placeholder="Rol"
                                   th:field="${usuario.Rol.nombre}" onkeypress="username(event, this)" readonly>
                            <span class="text-danger error-msg"></span>
                        </div>



                        <!-- CORREO / TELÉFONOS -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Correo</label>
                            <input type="email" class="form-control" placeholder="Correo"
                                   th:field="${usuario.Email}" onkeypress="Email(event, this)" readonly>
                            <span class="text-danger error-msg"></span>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Teléfono</label>
                            <input type="text" class="form-control" placeholder="Telefono"
                                   th:field="${usuario.Telefono}" oninput="numeroCT(event, this)" readonly>
                            <span class="text-danger error-msg"></span>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Celular</label>
                            <input type="tel" class="form-control" placeholder="Celular"
                                   th:field="${usuario.Celular}" oninput="numeroCT(event, this)" readonly>
                            <span class="text-danger error-msg"></span>
                        </div>

                        <!-- FECHA / CURP / SEXO -->
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Fecha de Nacimiento</label>
                            <input type="date" class="form-control"
                                   th:field="${usuario.fechanacimiento}" onblur="Fecha(event, this)" readonly>
                            <span class="text-danger error-msg"></span>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">CURP</label>
                            <input type="text" class="form-control" placeholder="Curp"
                                   th:field="${usuario.Curp}" oninput="Curp(event, this)" readonly>
                            <span class="text-danger error-msg"></span>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold d-block">Sexo</label>
                            <div class="btn-group" role="group" >
                                <input type="radio"  class="btn-check" name="sexo" id="sexoH" autocomplete="off"
                                       th:field="${usuario.Sexo}" value="H " readonly>
                                <label class="btn btn-outline-primary" for="sexoH"><i class="bi bi-person-standing"></i> Hombre</label>

                                <input type="radio" class="btn-check" name="sexo" id="sexoM" autocomplete="off"
                                       th:field="${usuario.Sexo}" value="M " >
                                <label class="btn btn-outline-primary" for="sexoM"><i class="bi bi-person-standing-dress"></i> Mujer</label>
                            </div>
                        </div>

                        <!-- Button trigger modal -->
                        <div class="col-12 mb-3">
                            <button type="button" class="btn btn-primary w-100 w-md-auto" th:disabled="${session.userEstatus == 0 || session.userEstatus == 2}" data-bs-toggle="modal" data-bs-target="#editarUsuario">
                                Editar Datos
                            </button>
                        </div>
                    </div>
                </div>

                <!-- DIRECCIONES -->
                <div class="col-12 col-lg-6">
                    <h3>Dirección(es)</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Calle</th>
                                <th scope="col">Número Interior</th>
                                <th scope="col">Número Exterior</th>
                                <th scope="col">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${usuario.Direcciones != null}" th:each="direccion : ${usuario.Direcciones}">
                                <td th:text="${direccion.Calle}"></td>
                                <td th:text="${direccion.NumeroInterior}"></td>
                                <td th:text="${direccion.NumeroExterior}"></td>

                                <td>
                                    <!--                                    <input type="text" th:text="${direccion.idDireccion}">-->
                                    <input type="text" th:value="${direccion.idDireccion}" style="display:none;">

                                    <div>
                                        <a class="btn btn-warning btn-sm me-2"
                                           data-bs-toggle="modal"
                                           data-bs-target="#modalDireccion" th:disabled="${session.userEstatus == 0 || session.userEstatus == 2}" th:onclick="|modalDireccionEdit(${direccion.idDireccion})|">
                                            <i class="bi bi-pencil-square"></i> Editar
                                        </a>




                                        <button th:disabled="${session.userEstatus == 0 || session.userEstatus == 2}" th:onclick="|EliminarDireccion(${usuario.IdUsuario},${direccion.idDireccion})|" class="btn btn-danger">
                                            <i class="bi bi-trash-fill"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr th:unless="${usuario.Direcciones != null}">
                                <td colspan="4">Sin dirección.</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="mt-2">
                        <!--                        <a class="btn btn-warning btn-sm me-2"
                                                                   data-bs-toggle="modal"
                                                                   data-bs-target="#modalDireccion" th:onclick="|modalDireccionEdit(${direccion.idDireccion})|">
                                                                    <i class="bi bi-pencil-square"></i> agregar
                                                                </a>-->
                        <!--                        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#agregarDireccion">
                                                    Agregar Dirección
                                                </button>-->
                        <button th:disabled="${session.userEstatus == 0 || session.userEstatus == 2}" type="button" class="btn btn-secondary" onclick="modalDireccionEdit(0)" >
                            Agregar Dirección
                        </button>


                    </div>
                    <input type="hidden" th:field="${usuario.idUsuario}">
                </div>
            </div>

            <!-- Modal editar usuario -->
            <div class="modal fade" id="editarUsuario" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">Editar Usuario</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <form method="post" th:object="${usuario}" th:action="@{/usuario/editar}" enctype="multipart/form-data">
                            <input type="hidden" class="form-control" th:field="${usuario.idUsuario}">
                            <input type="hidden" th:field="*{idUsuario}" id="idusuario">

                            <div class="modal-body">

                                <div class="row g-3">
                                    <!-- ==================== NOMBRE Y APELLIDOS ==================== -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold">Nombre</label>
                                        <input type="text" class="form-control" placeholder="Nombre"
                                               th:field="${usuario.Nombre}" onkeypress="SoloLetras(event, this)">
                                        <span class="text-danger error-msg"></span>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold">Apellido Paterno</label>
                                        <input type="text" class="form-control" placeholder="Apellido Paterno"
                                               th:field="${usuario.ApellidoPaterno}" onkeypress="SoloLetras(event, this)">
                                        <span class="text-danger error-msg"></span>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold">Apellido Materno</label>
                                        <input type="text" class="form-control" placeholder="Apellido Materno"
                                               th:field="${usuario.ApellidoMaterno}" onkeypress="SoloLetras(event, this)">
                                        <span class="text-danger error-msg"></span>
                                    </div>

                                    <!-- ==================== USERNAME Y PASSWORD ==================== -->
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Username</label>
                                        <input type="text" class="form-control" placeholder="username"
                                               th:field="${usuario.username}" onkeypress="username(event, this)">
                                        <span class="text-danger error-msg"></span>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Password</label>
                                        <input type="text" 
                                               class="form-control" 

                                               name="password"
                                               placeholder="Dejar en blanco para no cambiar"
                                               oninput="password(event, this)">
                                        <span class="text-danger error-msg"></span>
                                    </div>

                                    <!-- ==================== CORREO / TELÉFONOS ==================== -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold">Correo</label>
                                        <input type="email" class="form-control" placeholder="Correo"
                                               name="Email" th:value="*{Email}" oninput="Email(event, this)">
                                        <span class="text-danger error-msg"></span>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold">Teléfono</label>
                                        <input type="text" class="form-control" placeholder="Telefono"
                                               th:field="${usuario.Telefono}" oninput="numeroCT(event, this)">
                                        <span class="text-danger error-msg"></span>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold">Celular</label>
                                        <input type="tel" class="form-control" placeholder="Celular"
                                               th:field="${usuario.Celular}" oninput="numeroCT(event, this)">
                                        <span class="text-danger error-msg"></span>
                                    </div>

                                    <!-- ==================== FECHA / CURP / SEXO ==================== -->
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold">Fecha</label>
                                        <input type="date" class="form-control"
                                               th:field="*{fechanacimiento}" oninput="ValidarFecha(event, this)">
                                        <span class="text-danger error-msg"></span>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold">Curp</label>
                                        <input type="text" class="form-control" placeholder="Curp"
                                               th:field="*{Curp}" oninput="ValidarCurp(event, this)">
                                        <span class="text-danger error-msg"></span>
                                    </div>

                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-bold d-block">Sexo</label>

                                        <div class="col-md-6">

                                            <div class="btn-group" role="group">
                                                <input type="radio" class="btn-check" name="sexoE" id="sexoHE" autocomplete="off" th:field="${usuario.Sexo}" value="H ">
                                                <label class="btn btn-outline-primary" for="sexoHE"><i class="bi bi-person-standing"></i> Hombre</label>

                                                <input type="radio" class="btn-check" name="sexoE" id="sexoME" autocomplete="off" th:field="${usuario.Sexo}" value="M ">
                                                <label class="btn btn-outline-primary" for="sexoME"><i class="bi bi-person-standing-dress"></i> Mujer</label>

                                            </div>
                                        </div>

                                    </div>                                   
                                    <div sec:authorize="hasRole('Admin')"> 
                                        <label for="RolUsuario" class="form-label">Rol</label>
                                        <select class="form-select" id="RolUsuario" th:field="*{rol.idRol}">
                                            <option value="0">Selecciona un Rol</option>
                                            <option th:each="rol : ${Roles}" th:text="${rol.Nombre}" th:value="${rol.idRol}"></option>
                                        </select>
                                    </div>
                                </div>

                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
                                <button type="submit" class="btn btn-primary">Editar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>


            <!-- Modal Editar Direccion -->
            <div class="modal fade" id="modalDireccion" tabindex="-1"
                 aria-labelledby="modalDireccionLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">


                        <!-- Header -->
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalDireccionLabel">
                                Dirección
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>


                        <!-- Body -->
                        <div class="modal-body">
                            <div class="row g-3">

                                <div class="row g-3">
                                    <div class="col-md-6">


                                        <label class="form-label fw-semibold">Calle</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text"><i class="bi bi-signpost-split"></i></span>
                                            <input type="text"  class="form-control" id="Calle" placeholder="Calle">
                                            <input type="hidden" id="iddireccion">


                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-semibold">Número Ext</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text"><i class="bi bi-hash"></i></span>
                                            <input type="text"   class="form-control" id="NumeroExterior" placeholder="Exterior" >
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-semibold">Número Int</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text"><i class="bi bi-door-open"></i></span>
                                            <input type="text" class="form-control" id="NumeroInterior" placeholder="Interior">
                                        </div>
                                    </div>
                                </div>

                                <div class="row g-3 mt-2">
                                    <div class="col-md-3">
                                        <label class="form-label fw-semibold">País</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text"><i class="bi bi-globe-americas"></i></span>
                                            <select id="ddlpais" class="form-select">
                                                <option value="0" selected>Selecciona un país</option>
                                                <option th:each="pais : ${Paises}" th:text="${pais.Nombre}"
                                                        th:value="${pais.idPais}"></option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-semibold">Estado</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text"><i class="bi bi-map"></i></span>
                                            <select id="ddlestado" class="form-select">
                                                <option value="0" selected>Selecciona un estado</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-semibold">Municipio</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text"><i class="bi bi-map-fill"></i></span>
                                            <select id="ddlmunicipio" class="form-select">
                                                <option value="0" selected>Selecciona un municipio</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label fw-semibold">Colonia</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text"><i class="bi bi-house-door"></i></span>
                                            <select id="ddlcolonia" class="form-select">
                                                <option value="0" selected>Selecciona una colonia</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">
                                Cerrar
                            </button>
                            <!--                                onclick="enviarDireccion()"-->
                            <button type="button" class="btn btn-success" onclick="enviarDireccion()">Guardar dirección

                            </button>
                        </div>

                    </div>
                </div>
            </div>


            <!--Modal de Bloqueo segun el estatus-->

            <div th:if="${session.userEstatus != 1}" id="bloqueoModal" 
                 class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-danger shadow-lg">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title"><i class="bi bi-lock-fill"></i> Cuenta Restringida</h5>
                        </div>
                        <div class="modal-body text-center">
                            <p class="fs-5" th:text="${session.userEstatus == 0 ? 
                               'Tu cuenta está deshabilitada temporalmente.' : 
                               'Tu cuenta ha expirado.'}"></p>
                            <p class="text-muted">No puedes realizar acciones hasta que un administrador te habilite.</p>
                        </div>
                        <div class="modal-footer">
                            <a th:href="@{/logout}" class="btn btn-secondary">Cerrar Sesión</a>
                        </div>
                    </div>
                </div>
            </div>


        </div>

    </body>

    <script th:if="${session.userEstatus != 1}">
        window.onload = function () {
            var modalBloqueo = new bootstrap.Modal(document.getElementById('bloqueoModal'));
            modalBloqueo.show();
        };
    </script>


    <script>

        function EliminarDireccion(idUsuario, idDireccion) {

            Swal.fire({
                title: "¿Estas seguro de eliminar la direccion?",
                text: "La direccion se va a eliminar",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Si, borrar"
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch("/api/direccion/" + idUsuario + "/" + idDireccion, {
                        method: 'DELETE'
                    })
                            .then(response => response.json())
                            .then(data => {
                                if (data.Correct) {
                                    Swal.fire("¡Borrado!", "La direccion se eliminó correctamente", "success")
                                            .then(() => {
                                                location.reload();
                                            });
                                } else {
                                    Swal.fire("Error", data.ErrorMessage, "error");
                                }
                            })
                            .catch(error => {
                                Swal.fire("Error", "Ocurrió un fallo en la conexión", "error");
                            });
                }
            });
        }

        var idEstadoPendiente = 0;
        var idMunicipioPendiente = 0;
        var idColoniaPendiente = 0;

        $(document).ready(function () {
            $("#ddlpais").on("change", function () {
                const paisId = $(this).val();
                if (paisId != 0 && paisId != null) {
                    $.ajax({
                        url: "/api/estado/getEstadosByPais/" + paisId,
                        type: "GET",
                        success: function (data) {
                            $("#ddlestado").empty().append("<option value='0'>Selecciona un estado</option>");
                            $.each(data.object || data.Objects, function (i, estado) {
                                $("#ddlestado").append(`<option value="${estado.idEstado}">${estado.nombre}</option>`);
                            });
                            // Si es edición, seleccionamos el siguiente nivel
                            if (idEstadoPendiente > 0) {
                                $("#ddlestado").val(idEstadoPendiente).trigger('change');
                                idEstadoPendiente = 0;
                            }
                        }
                    });
                }
            });

            $("#ddlestado").on("change", function () {
                const estadoId = $(this).val();
                if (estadoId != 0 && estadoId != null) {
                    $.ajax({
                        url: "/api/municipio/getMunicipioByEstado/" + estadoId,
                        type: "GET",
                        success: function (data) {
                            $("#ddlmunicipio").empty().append("<option value='0'>Selecciona un municipio</option>");
                            $.each(data.object || data.Objects, function (i, municipio) {
                                $("#ddlmunicipio").append(`<option value="${municipio.idMunicipio}">${municipio.nombre}</option>`);
                            });
                            if (idMunicipioPendiente > 0) {
                                $("#ddlmunicipio").val(idMunicipioPendiente).trigger('change');
                                idMunicipioPendiente = 0;
                            }
                        }
                    });
                }
            });

            $("#ddlmunicipio").on("change", function () {
                const municipioId = $(this).val();
                if (municipioId != 0 && municipioId != null) {
                    $.ajax({
                        url: "/api/colonia/getColoniaByMunicipio/" + municipioId,
                        type: "GET",
                        success: function (data) {
                            $("#ddlcolonia").empty().append("<option value='0'>Selecciona una colonia</option>");
                            $.each(data.object || data.Objects, function (i, colonia) {
                                $("#ddlcolonia").append(`<option value="${colonia.idColonia}">${colonia.nombre}</option>`);
                            });
                            if (idColoniaPendiente > 0) {
                                $("#ddlcolonia").val(idColoniaPendiente);
                                idColoniaPendiente = 0;
                            }
                        }
                    });
                }
            });
        });

        function modalDireccionEdit(IdDireccion) {
            $('#iddireccion').val(IdDireccion);

            // Limpiar campos siempre al abrir
            $('#Calle').val('');
            $('#NumeroExterior').val('');
            $('#NumeroInterior').val('');
            $('#ddlpais').val(0);
            $('#ddlestado').empty().append("<option value='0'>Selecciona un estado</option>");
            $('#ddlmunicipio').empty().append("<option value='0'>Selecciona un municipio</option>");
            $('#ddlcolonia').empty().append("<option value='0'>Selecciona una colonia</option>");

            if (IdDireccion !== 0) {
                $.ajax({
                    url: '/api/direccion/' + IdDireccion,
                    type: 'GET',
                    success: function (result) {
                        const res = result.object;
                        $('#Calle').val(res.calle);
                        $('#NumeroExterior').val(res.numeroExterior);
                        $('#NumeroInterior').val(res.numeroInterior);

                        idEstadoPendiente = res.colonia.municipio.estado.idEstado;
                        idMunicipioPendiente = res.colonia.municipio.idMunicipio;
                        idColoniaPendiente = res.colonia.idColonia;

                        $('#ddlpais').val(res.colonia.municipio.estado.pais.idPais).trigger('change');
                    }
                });
            }

            $('#modalDireccion').modal('show');
        }

        function enviarDireccion() {
            /* Setear los Valores obtenidos. */
            const direccion = {
                idDireccion: $('#iddireccion').val(),
                calle: $('#Calle').val(),
                numeroExterior: $('#NumeroExterior').val(),
                numeroInterior: $('#NumeroInterior').val(),
                pais: $('#ddlpais').val(),
                estado: $('#ddlestado').val(),
                idmunicipio: $('#ddlmunicipio').val(),
                colonia: {
                    idColonia: $('#ddlcolonia').val(),
                    municipio: {
                        idMunicipio: $('#ddlmunicipio').val(),
                        estado: {
                            idEstado: $('#ddlestado').val(),
                            pais: {
                                idPais: $('#ddlpais').val()
                            }
                        }
                    }
                },
                usuario: {
                    idUsuario: $('#idusuario').val()
                }

            };
            console.log($('#iddireccion').val());
            var idUsuario = $('#idusuario').val();
            console.log(idUsuario);
            console.log("Objeto dirección:", direccion);
            Swal.fire({
                title: "¿Estas seguro?",
                text: "Se agregara o editara una direccion",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Si"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/usuario/addDireccion/' + idUsuario,
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(direccion),
                        success: function (response) {
                            Swal.fire("¡Guardado!", "La dirección se guardó con éxito.", "success")
                                    .then(() => {
                                        window.location.href = '/usuario/detail/' + idUsuario;
                                    });
                        },
                        error: function (xhr) {
                            console.error("Error:", xhr.responseText);
                            Swal.fire("Error", "Hubo un problema al guardar.", "error");
                        }
                    });
                }
            });
        }



    </script>
    <script>

        function numeroCT(event, input) {
            let RegExp = /^\d{10}$/;
            if (RegExp.test(input.value)) {
                $(input).removeClass("error").addClass("correct");
                $(input).siblings(".error-msg").text("");
            } else {
                $(input).removeClass("correct").addClass("error");
                $(input).siblings(".error-msg").text("Ingresa un número válido");
            }
        }

        function ValidarCurp(event, input) {
            input.value = input.value.toUpperCase(); // Esto convierte el texto mientras escriben
            let value = input.value;
            let RegExp = /^[A-Z]{4}[0-9]{6}[A-Z]{7}[0-9]{1}$/;

            if (RegExp.test(value)) {
                $(input).removeClass("error").addClass("correct").siblings(".error-msg").text("");
            } else {
                $(input).removeClass("correct").addClass("error").siblings(".error-msg").text("Ingresa una CURP válida");
            }
        }

        function SoloLetras(event, input) {
            let key = event.key;
            let RegExp = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/;
            if (RegExp.test(key)) {
                $(input).removeClass("error").addClass("correct");
                $(input).siblings(".error-msg").text("");
            } else {
                $(input).removeClass("correct").addClass("error");
                $(input).siblings(".error-msg").text("No se permiten numeros");
                event.preventDefault();
            }
        }

        function Email(event, input) {
            let valor = input.value;
            let regExp = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,5}$/;

            if (valor === "") {
                $(input).removeClass("error correct");
                $(input).siblings(".error-msg").text("");
            } else if (regExp.test(valor)) {
                $(input).removeClass("error").addClass("correct");
                $(input).siblings(".error-msg").text("");
            } else {
                $(input).removeClass("correct").addClass("error");
                $(input).siblings(".error-msg").text("Ingresa un correo válido");
            }
        }

        function ValidarFecha(event, input) {
            const valor = input.value;
            const $input = $(input);
            const $errorMsg = $input.siblings(".error-msg");

            if (!valor) {
                $input.removeClass("correct error");
                $errorMsg.text("");
                return;
            }


            const fechaSeleccionada = new Date(valor);

            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);


            if (fechaSeleccionada <= hoy) {
                $input.removeClass("error").addClass("correct");
                $errorMsg.text("");
            } else {
                $input.removeClass("correct").addClass("error");
                $errorMsg.text("Ingrese una fecha correcta");
            }
        }

        function username(event, input) {
            let key = event.key;
            let RegExp = /\w+/;
            if (RegExp.test(key)) {
                $(input).removeClass("error").addClass("correct");
            } else {
                $(input).removeClass("correct").addClass("error");
                $(input).siblings(".error-msg").text("Ingresa un usuario valido");
                event.preventDefault();
            }

        }

        function password(event, input) {

            let RegExp = /^(?=\w*\d)(?=\w*[A-Z])(?=\w*[a-z])\S{8,}$/;
            if (RegExp.test(input.value)) {

                $(input).removeClass("error").addClass("correct");
                $(input).siblings(".error-msg").text(""); // Limpiar el mensaje de error
            } else {

                $(input).removeClass("correct").addClass("error");
                $(input).siblings(".error-msg").text("Ingresa una contraseña de mínimo 8 dígitos con al menos una mayúscula y número.");
            }
        }

    </script>


</html>
